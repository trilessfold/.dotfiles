#!/usr/bin/env python3

import os
import re
import sys
import requests

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
API_KEY = "YOUR_KEY_HERE"
DOWNLOAD_DIR = "./redmine_files"

# === –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–°–°–ò–ò ===
session = requests.Session()
session.headers.update({
    "X-Redmine-API-Key": API_KEY,
    "Content-Type": "application/json"
})

def parse_issue_url(url: str):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å Redmine –∏ ID –∑–∞–¥–∞—á–∏ –∏–∑ —Å—Å—ã–ª–∫–∏.
    –ü—Ä–∏–º–µ—Ä:
      https://redmine.example.com/issues/1234  -> ('https://redmine.example.com', '1234')
    """
    match = re.match(r"(https?://[^/]+)/issues/(\d+)", url)
    if not match:
        print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏. –ü—Ä–∏–º–µ—Ä: https://redmine.example.com/issues/1234")
        sys.exit(1)
    base_url, issue_id = match.groups()
    return base_url, issue_id


def download_attachments(redmine_url: str, issue_id: str):
    issue_url = f"{redmine_url}/issues/{issue_id}.json?include=attachments"
    resp = session.get(issue_url)

    if resp.status_code != 200:
        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á—É {issue_id}: {resp.status_code}")
        return

    issue = resp.json().get("issue", {})
    attachments = issue.get("attachments", [])
    if not attachments:
        print(f"‚ÑπÔ∏è –ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π –≤ –∑–∞–¥–∞—á–µ {issue_id}")
        return

    issue_dir = os.path.join(DOWNLOAD_DIR, f"{issue_id}")
    os.makedirs(issue_dir, exist_ok=True)

    for att in attachments:
        filename = att["filename"]
        file_url = att["content_url"]
        print(f"üì• –°–∫–∞—á–∏–≤–∞—é {filename} –∏–∑ –∑–∞–¥–∞—á–∏ #{issue_id}...")

        file_resp = session.get(file_url)
        if file_resp.status_code == 200:
            with open(os.path.join(issue_dir, filename), "wb") as f:
                f.write(file_resp.content)
        else:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è {filename}: {file_resp.status_code}")

    print(f"‚úÖ –ó–∞–¥–∞—á–∞ #{issue_id}: –≤—Å–µ –≤–ª–æ–∂–µ–Ω–∏—è —Å–∫–∞—á–∞–Ω—ã.")


def main():
    if len(sys.argv) < 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python redmine_download.py <—Å—Å—ã–ª–∫–∞_–Ω–∞_–∑–∞–¥–∞—á—É>")
        sys.exit(1)

    issue_url = sys.argv[1]
    redmine_url, issue_id = parse_issue_url(issue_url)
    os.makedirs(DOWNLOAD_DIR, exist_ok=True)
    download_attachments(redmine_url, issue_id)


if __name__ == "__main__":
    main()

